@using System.Security.Claims
@model IEnumerable<InkCanvas.Models.Comment>
@inject Microsoft.AspNetCore.Identity.UserManager<InkCanvas.Models.User> UserManager

<h4>Comments</h4>
@if (Model.Any())
{
    <hr />
    <div id="comments-section">
        @foreach (var item in Model)
        {
            var user = await UserManager.FindByIdAsync(item.UserId);
            <div class="comment" id="comment-@item.CommentId">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">@user.Login</h5>
                    <p class="mb-1">@item.Date</p>
                </div>
                <p class="mb-1">@item.Caption</p>
                @if (User.FindFirstValue(ClaimTypes.NameIdentifier) == item.UserId)
                {
                    <div class="col-md-6 mb-1">
                        <button class="btn btn-secondary" onclick="deleteComment(@item.CommentId)">🗑</button>
                    </div>
                }
                <hr />
            </div>
        }
    </div>

    @if (!User.Identity.IsAuthenticated)
    {
        <p>Log in to comment</p>
    }
}
else if (User.Identity.IsAuthenticated)
{
    <p>Be the first person to comment.</p>
}
else
{
    <p>Log in to comment.</p>
}

<script>
    function deleteComment(commentId) {
        if (confirm("Are you sure you want to delete this comment?")) {
            $.ajax({
                url: '@Url.Action("Delete", "Comments")',
                type: 'POST',
                data: { id: commentId },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (result) {
                    if (result.success) {
                        $('#comment-' + commentId).remove();
                    } else {
                        alert("There was an error deleting comment.");
                    }
                },
                error: function (xhr, status, error) {
                    alert("Error: " + error);
                }
            });
        }
    }

</script>
